---
title: "Texas Blackouts Winter Storm Uri, February, 2021"
author: "Henry Oliver"
format: html
---
# Purpose
The purpose of this analysis is to estimate the number of homes in Houston, Texas that experienced a blackout during Winter Storm Uri in February of 2021. 

# Load Packages
```{r}
#| message: false
library(tidyverse)
library(janitor)
library(sf) # vector handling
library(terra) # raster handling
library(tidyverse)
library(tmap) # map making
library(spData) # spatial data
library(spDataLarge) # spatial data
library(viridisLite)
library(stars)
library(raster)
```

# 1) Nightlights over Houston
#### 1a) Import data
```{r}
#| message: false
# nightlight data for February 7, tile h08v05
nl_feb7_05 <- read_stars("data/VNP46A1/VNP46A1.A2021038.h08v05.001.2021039064328.tif")

# nightlight data for February 7, tile h08v06
nl_feb7_06 <- read_stars("data/VNP46A1/VNP46A1.A2021038.h08v06.001.2021039064329.tif")

# nightlight data for February 16, tile h08v05
nl_feb16_05 <- read_stars("data/VNP46A1/VNP46A1.A2021047.h08v05.001.2021048091106.tif")

# nightlight data for February 16, tile h08v06
nl_feb16_06 <- read_stars("data/VNP46A1/VNP46A1.A2021047.h08v06.001.2021048091105.tif")


```

#### 1b) Check dimensions, resolution, and CRS
```{r}
# Check dimensions
if (all(dim(nl_feb7_06) == dim(nl_feb16_05)) && 
    all(dim(nl_feb7_06) == dim(nl_feb16_06)) &&
    all(dim(nl_feb7_06) == dim(nl_feb7_05))) {
  message("All rasters have the same dimensions")
} else {
  message("Rasters do not have the same dimensions")
}

# Check resolution
if (all(st_res(nl_feb7_06) == st_res(nl_feb16_05)) && 
    all(st_res(nl_feb7_06) == st_res(nl_feb16_06)) &&
    all(st_res(nl_feb7_06) == st_res(nl_feb7_05))) {
  message("All rasters have the same resolution")
} else {
  message("Rasters do not have the same resolution")
}

# Compare CRS of rasters
rasters <- list(nl_feb7_05, nl_feb7_06, nl_feb16_05, nl_feb16_06)

crs_match <- all(sapply(rasters[-1], function(x) compareCRS(rasters[[1]], x)))

if (crs_match) {
  message ("All Rasters have the same CRS")
} else {
  message("All Rasters do NOT have the same CRS")
}
```

#### 1c) Create blackout mask
```{r}
#| warning: false
# merge rasters
nl_feb7 = st_mosaic(nl_feb7_05, nl_feb7_06)
nl_feb16 = st_mosaic(nl_feb16_05, nl_feb16_06)

# Find the difference between the two rasters for both tiles
nl_diff <- (nl_feb7 - nl_feb16)

# Create reclassification matrix using external function
source("class_function.R")

# Apply reclassification function
diff_rcf <- st_apply(nl_diff, MARGIN = c(1, 2), FUN = function(x) reclassify(x, threshold = 200))

# Transform into vector for ease of merging with census and highway data
mask_vector = st_as_sf(diff_rcf)

# Crop mask to City of Houston
bounds <- st_bbox(c(xmin = -96.5, ymin = 29, xmax = -94.5, ymax = 30.5))
houston_mask <- st_crop(mask_vector, bounds)

```

Now that we have our blackout mask, we need to eliminate any lights that are not from housing. In order to do this, we will remove the lights within 200m of all highways

# 2) Texas Highways
#### 2a) Read data and create 200m buffer around highway vectors
```{r}
# Read in highway data, specify only highways
highways <- st_read("data/gis_osm_roads_free_1.gpkg", 
        query = "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'",
        quiet = TRUE)

# Current CRS degrees are 'degrees', we need them to be meters.
# Reproject on WGS 84 / UTM Zone 15N
highways <- st_transform(highways, 32615)

hw_buffer <- st_buffer(highways, dist = 200)

```

#### 2b) Reproject so mask and highway buffer have the same CRS and extent
```{r}
# Reproject
houston_mask <- st_transform(houston_mask, crs = st_crs(hw_buffer))

# Check to make sure CRS matches
if (st_crs(houston_mask) == st_crs(hw_buffer)) {
  message("CRS match")
} else {
  message("CRS do not match")
  houston_mask <- st_transform(houston_mask, st_crs(hw_buffer))
}

# Crop buffer to be same size as the mask
hw_buffer_cropped <- st_crop(hw_buffer, st_bbox(houston_mask))

if (identical(st_bbox(hw_buffer_cropped), st_bbox(houston_mask))) {
  message("Bounds match")
} else {
  warning("Bounds do not match")
}

```

#### 2c) Remove highway buffer from Houston Blackout Mask
```{r}
# This will take forever if they're both vectors, so lets turn them back into rasters
# Create empty raster with 10m resolution
r <- rast(houston_mask, res = 10)
# Rasterize. 
blackout_rast <- rasterize(houston_mask, r)
hw_rast <- rasterize(hw_buffer_cropped, r)

# Subtract all areas within 200m of highways from blackout mask
residential_blackouts <- mask(blackout_rast, hw_rast, maskvalues = 1, updatevalue = NA)

```


# 3) Estimate of homes that lost power

#### 3a) Read in homes data, match CRS.
```{r}
# Read in homes data, specify residences
homes <- st_read("data/gis_osm_buildings_a_free_1.gpkg",
  query = "
    SELECT *
    FROM gis_osm_buildings_a_free_1
    WHERE 
      (type IS NULL AND name IS NULL)
      OR type IN ('residential', 'apartments', 'house', 'static_caravan', 'detached')
  ",
  quiet = TRUE
) %>% janitor::clean_names()

# Check to make sure CRS matches. If not, match them
if (st_crs(homes) == st_crs(residential_blackouts)) {
  message("CRS match")
} else {
  message("CRS do not match, transforming CRS to st_crs(residential_blackouts)")
  homes <- st_transform(homes, st_crs(residential_blackouts))
}

```

Now we have a raster of all non-highway locations in Houston that experienced a blackout, and a shapefile with  a multipolygon for each residence in Houston. The CRS Matches. The next thing we need to do is find out how many of the homes fall within the blackout raster. In order to do this, we will need to turn the homes into points, turn the blackout raster back into a vector, and use st_intersects to find the number of points within polygons created by the blackout raster
```{r}
# Turn blackout raster into polygons where blackout is present, merge adjacent polygons
blackout_polygons <- as.polygons(residential_blackouts == 1, dissolve = TRUE) %>% 
  st_as_sf()

# Turn homes into points
homes_points <- st_centroid(homes) %>% 
  st_as_sf()

homes_points$in_blackout <- lengths(st_intersects(homes_points, blackout_polygons)) > 0

plot1 <- tm_shape(blackout_polygons) +
  tm_polygons(fill_alpha = "black", alpha = 0.5) +
  tm_shape(homes_points) +
  tm_symbols(
    col = "in_blackout",
    palette = c("grey70", "red"),
    size = 0.05,
    col_alpha = 0
  ) +
  tm_title("Homes within blackout areas")


# Get number of homes that lost power
sum(homes_points$in_blackout, na.rm = TRUE)
```




